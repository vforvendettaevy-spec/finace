<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Dashboard PEA - LUKA_INVEST_PRO</title>
<link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='0.9em' font-size='90'>📊</text></svg>" />
<style>
/* Styles inspirés de ton design : vert/violet, gros format lisible - MODE SOMBRE */
*{box-sizing:border-box}
body{
  font-family: "Segoe UI", Roboto, Arial, sans-serif;
  background: linear-gradient(135deg,#0a0e14 0%,#1a1f2e 100%);
  margin:0;padding:22px;color:#e2e8f0;
}
.container{max-width:1400px;margin:0 auto;}
.header{
  background:linear-gradient(135deg,#39b46e 0%,#2d8f57 100%);
  color:#fff;padding:36px;border-radius:18px;margin-bottom:26px;
  box-shadow:0 10px 40px rgba(57,180,110,0.18);text-align:center;
}
.header h1{font-size:34px;margin-bottom:6px}
.header p{opacity:.95;font-size:16px}
.params-section{
  background:#1e2433;border-radius:14px;padding:26px;margin-bottom:22px;
  box-shadow:0 6px 20px rgba(0,0,0,0.4);border:1px solid #2d3748;
}
.params-title{font-size:20px;font-weight:700;color:#e2e8f0;margin-bottom:16px;display:flex;gap:10px;align-items:center}
.params-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(240px,1fr));gap:16px}
.param-item{background:#2d3748;padding:14px;border-radius:10px;border:1px solid #374151;transition:all .18s}
.param-item:hover{transform:translateY(-3px);border-color:#39b46e;}
.param-item label{display:block;font-weight:600;color:#cbd5e0;margin-bottom:8px}
.param-item input{width:100%;padding:10px;border-radius:8px;border:1px solid #4a5568;font-size:15px;background:#1a202c;color:#e2e8f0}
.btn-primary{background:linear-gradient(135deg,#39b46e 0%,#2d8f57 100%);color:#fff;border:none;padding:12px 28px;border-radius:12px;font-weight:700;cursor:pointer;box-shadow:0 6px 18px rgba(57,180,110,.18);transition:transform .2s}
.btn-primary:hover{transform:translateY(-3px)}
.btn-primary:active{transform:translateY(0)}
.stats-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(220px,1fr));gap:16px;margin:20px 0}
.stat-card{background:#1e2433;padding:18px;border-radius:12px;box-shadow:0 6px 18px rgba(0,0,0,0.4);border:1px solid #2d3748}
.stat-label{font-size:13px;color:#9ca3af;margin-bottom:8px}
.stat-value{font-size:30px;font-weight:800;color:#e2e8f0}
.progress-bar{background:#2d3748;height:32px;border-radius:18px;overflow:hidden;margin-top:12px}
.progress-fill{height:100%;display:flex;align-items:center;justify-content:center;font-weight:700;color:#fff;background:linear-gradient(90deg,#39b46e,#2d8f57);transition:width .5s}
.chart-section{background:#1e2433;border-radius:14px;padding:22px;margin-bottom:22px;box-shadow:0 6px 20px rgba(0,0,0,0.4);border:1px solid #2d3748}
.section-title{font-size:18px;font-weight:800;color:#e2e8f0;margin-bottom:14px}
.table-controls{display:grid;grid-template-columns:200px 160px 120px;gap:10px;margin-bottom:12px}
.table-controls input[type="month"],
.table-controls input[type="number"]{
  padding:10px;
  border-radius:8px;
  border:1px solid #4a5568;
  background:#2d3748;
  color:#e2e8f0;
  font-size:15px;
}
.btn-add{background:linear-gradient(135deg,#7a6ff0,#6355cc);color:#fff;padding:10px;border-radius:8px;border:none;font-weight:700;cursor:pointer}
.btn-delete{background:#e53e3e;color:#fff;border:none;padding:8px 10px;border-radius:6px;cursor:pointer}
table{width:100%;border-collapse:collapse;margin-top:10px}
th,td{padding:12px;text-align:left;border-bottom:1px solid #374151;color:#e2e8f0}
th{background:#2d3748;color:#cbd5e0;font-weight:700;font-size:13px}
.positive{color:#39b46e;font-weight:800}
.projection-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(150px,1fr));gap:14px;margin-top:10px}
.projection-card{background:linear-gradient(135deg,#7a6ff0 0%,#6355cc 100%);color:#fff;padding:16px;border-radius:10px;text-align:center}
.projection-age{font-size:20px;font-weight:800}
.projection-amount{font-size:15px;opacity:.95}
@media (max-width:720px){
  .table-controls{grid-template-columns:1fr 1fr}
}
</style>
</head>
<body>
<div class="container">
  <div class="header">
    <h1>🎯 Mon Dashboard PEA</h1>
    <p>Objectif : 1 000 000 € à 45 ans · LUKA_INVEST_PRO</p>
  </div>

  <div class="params-section">
    <div class="params-title">⚙️ Mes paramètres</div>
    <div class="params-grid">
      <div class="param-item">
        <label>💰 Revenu mensuel (€)</label>
        <input id="revenu" type="number" value="1200" min="0" />
      </div>
      <div class="param-item">
        <label>📈 Investissement mensuel (€)</label>
        <input id="investissement" type="number" value="900" min="0" />
      </div>
      <div class="param-item">
        <label>🌍 MSCI World (%)</label>
        <input id="msciWorld" type="number" value="85" min="0" max="100" />
      </div>
      <div class="param-item">
        <label>🌏 Marchés émergents (%)</label>
        <input id="msciEM" type="number" value="15" min="0" max="100" />
      </div>
      <div class="param-item">
        <label>📊 Rendement annuel (%)</label>
        <input id="rendement" type="number" value="7" step="0.1" min="0" />
      </div>
      <div class="param-item">
        <label>💸 Frais de courtage (%)</label>
        <input id="fraisCourtage" type="number" value="0.2" step="0.1" min="0" />
      </div>
      <div class="param-item">
        <label>🎂 Mon âge actuel</label>
        <input id="age" type="number" value="17" min="0" />
      </div>
      <div class="param-item">
        <label>💚 Livret A (€)</label>
        <input id="livretA" type="number" value="3000" min="0" />
      </div>
      <div class="param-item">
        <label>💳 Compte courant (€)</label>
        <input id="compteCourant" type="number" value="0" min="0" />
      </div>
    </div>
    <div style="text-align:center;margin-top:16px">
      <button class="btn-primary" id="btnCalculer">🚀 Calculer ma projection</button>
    </div>
  </div>

  <div class="stats-grid">
    <div class="stat-card">
      <div class="stat-label">💰 Capital total estimé</div>
      <div class="stat-value" id="capitalTotal">0 €</div>
    </div>
    <div class="stat-card">
      <div class="stat-label">📈 Valeur PEA</div>
      <div class="stat-value" id="valeurPEA">0 €</div>
    </div>
    <div class="stat-card">
      <div class="stat-label">📈 Plus-value PEA</div>
      <div id="plusValue" style="font-size:28px;font-weight:800;color:#39b46e">+ 0 €</div>
    </div>
    <div class="stat-card">
      <div class="stat-label">📊 Rendement réel</div>
      <div class="stat-value" id="rendementReel" style="font-size:28px;color:#7a6ff0">0%</div>
    </div>
    <div class="stat-card">
      <div class="stat-label">🎯 Progression vers 1M€</div>
      <div class="stat-value" id="progression">0%</div>
      <div class="progress-bar"><div id="progressBar" class="progress-fill" style="width:0%">0%</div></div>
    </div>
  </div>

  <div class="chart-section">
    <div class="section-title">📈 Évolution de mon capital</div>
    <canvas id="chartEvolution" style="max-height:300px"></canvas>
  </div>

  <div class="chart-section">
    <div class="section-title">🎯 Calculateur d'objectif</div>
    <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:16px;margin-bottom:16px">
      <div>
        <label style="color:#cbd5e0;font-weight:600;display:block;margin-bottom:8px">💰 Objectif (€)</label>
        <input id="objectifMontant" type="number" value="1000000" min="0" style="width:100%;padding:10px;border-radius:8px;border:1px solid #4a5568;background:#2d3748;color:#e2e8f0;font-size:15px" />
      </div>
      <div>
        <label style="color:#cbd5e0;font-weight:600;display:block;margin-bottom:8px">🎂 Âge cible</label>
        <input id="objectifAge" type="number" value="45" min="0" style="width:100%;padding:10px;border-radius:8px;border:1px solid #4a5568;background:#2d3748;color:#e2e8f0;font-size:15px" />
      </div>
      <div style="display:flex;align-items:flex-end">
        <button class="btn-primary" onclick="calculerObjectif()" style="width:100%">🧮 Calculer</button>
      </div>
    </div>
    <div id="resultatObjectif" style="background:#2d3748;padding:20px;border-radius:10px;display:none">
      <p style="font-size:18px;color:#e2e8f0;margin:0"><strong>💡 Pour atteindre <span id="objMontant"></span> à <span id="objAge"></span> ans :</strong></p>
      <p style="font-size:24px;color:#39b46e;font-weight:800;margin:10px 0 0 0">Tu dois investir <span id="objInvestissement"></span> par mois</p>
    </div>
  </div>

  <div class="chart-section">
    <div class="section-title">🔮 Ma projection jusqu'à 45 ans</div>
    <div id="projectionGrid" class="projection-grid"></div>
  </div>

  <div class="chart-section">
    <div class="section-title">📅 Historique d'investissement</div>
    <div class="table-controls">
      <input id="nouveauMois" type="month" />
      <input id="nouveauMontant" type="number" placeholder="Montant (€)" value="900" />
      <button class="btn-add" onclick="ajouterMois()">➕ Ajouter</button>
    </div>

    <table>
      <thead>
        <tr>
          <th>📅 Mois</th>
          <th>💰 Versement</th>
          <th>🌍 MSCI World</th>
          <th>🌏 Émergents</th>
          <th>📈 Valeur cumulée</th>
          <th>💹 Plus-value</th>
          <th>🗑️</th>
        </tr>
      </thead>
      <tbody id="historique"></tbody>
    </table>
  </div>

  <div class="chart-section">
    <div class="section-title">📊 Projection détaillée par âge</div>
    <table id="tableProjection">
      <thead>
        <tr>
          <th>🎂 Âge</th>
          <th>⏱️ Années</th>
          <th>💰 Total versé (est.)</th>
          <th>📈 Capital estimé</th>
          <th>💹 Plus-value</th>
        </tr>
      </thead>
      <tbody id="projectionBody"></tbody>
    </table>
  </div>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
<script>
/* Dashboard JS complet */
let historiqueMois = [];
let chartInstance = null;

window.onload = function() {
  // restore saved data
  try {
    const saved = localStorage.getItem('dashboardData');
    if (saved) {
      const data = JSON.parse(saved);
      document.getElementById('revenu').value = data.revenu ?? 1200;
      document.getElementById('investissement').value = data.investissement ?? 900;
      document.getElementById('msciWorld').value = data.msciWorld ?? 85;
      document.getElementById('msciEM').value = data.msciEM ?? 15;
      document.getElementById('rendement').value = data.rendement ?? 7;
      document.getElementById('fraisCourtage').value = data.fraisCourtage ?? 0.2;
      document.getElementById('age').value = data.age ?? 17;
      document.getElementById('livretA').value = data.livretA ?? 3000;
      document.getElementById('compteCourant').value = data.compteCourant ?? 0;
      // rebuild historique
      historiqueMois = (data.historique || []).map(item => {
        return {
          mois: item.mois,
          montant: Number(item.montant) || 0,
          world: Number(item.world) || 0,
          em: Number(item.em) || 0,
          date: new Date((item.mois || '') + '-01'),
          id: Number(item.id) || Date.now() + Math.floor(Math.random()*1000)
        };
      });
      historiqueMois.sort((a,b) => a.date - b.date);
    }
  } catch(e) {
    console.warn('Erreur lecture storage', e);
    historiqueMois = [];
  }
  
  // Attacher l'événement au bouton
  document.getElementById('btnCalculer').addEventListener('click', calculer);
  
  // Calculer au chargement
  calculer();
};

function sauvegarder() {
  try {
    const data = {
      revenu: Number(document.getElementById('revenu').value) || 0,
      investissement: Number(document.getElementById('investissement').value) || 0,
      msciWorld: Number(document.getElementById('msciWorld').value) || 85,
      msciEM: Number(document.getElementById('msciEM').value) || 15,
      rendement: Number(document.getElementById('rendement').value) || 7,
      fraisCourtage: Number(document.getElementById('fraisCourtage').value) || 0.2,
      age: Number(document.getElementById('age').value) || 17,
      livretA: Number(document.getElementById('livretA').value) || 0,
      compteCourant: Number(document.getElementById('compteCourant').value) || 0,
      historique: historiqueMois.map(h => ({
        mois: h.mois,
        montant: h.montant,
        world: h.world,
        em: h.em,
        id: h.id
      }))
    };
    localStorage.setItem('dashboardData', JSON.stringify(data));
  } catch(e) {
    console.warn('Erreur sauvegarde', e);
  }
}

function calculer() {
  console.log('Calcul en cours...');
  
  const livretA = Number(document.getElementById('livretA').value) || 0;
  const compteCourant = Number(document.getElementById('compteCourant').value) || 0;
  const rendementAnn = Number(document.getElementById('rendement').value) || 7;
  const fraisCourtage = Number(document.getElementById('fraisCourtage').value) || 0.2;
  const rendement = (rendementAnn - fraisCourtage) / 100; // Rendement net après frais
  const age = Number(document.getElementById('age').value) || 17;
  const investissement = Number(document.getElementById('investissement').value) || 0;

  const today = new Date();
  let valeurPEA = 0;
  let totalVerse = 0;
  let totalFrais = 0;

  historiqueMois.sort((a,b) => a.date - b.date);

  historiqueMois.forEach(item => {
    const depDate = item.date instanceof Date ? item.date : new Date(item.mois + '-01');
    let monthsElapsed = (today.getFullYear() - depDate.getFullYear()) * 12 + (today.getMonth() - depDate.getMonth());
    if (monthsElapsed < 0) monthsElapsed = 0;
    const monthlyRate = rendement / 12;
    const fraisMontant = item.montant * (fraisCourtage / 100);
    const montantNet = item.montant - fraisMontant;
    const value = montantNet * Math.pow(1 + monthlyRate, monthsElapsed);
    valeurPEA += value;
    totalVerse += item.montant;
    totalFrais += fraisMontant;
  });

  const plusValue = valeurPEA - (totalVerse - totalFrais);
  const capitalTotal = livretA + compteCourant + valeurPEA;

  // Calcul du rendement réel
  let rendementReel = 0;
  if (totalVerse > 0 && historiqueMois.length > 0) {
    const firstDate = historiqueMois[0].date;
    const monthsTotal = (today.getFullYear() - firstDate.getFullYear()) * 12 + (today.getMonth() - firstDate.getMonth());
    if (monthsTotal > 0) {
      const yearsTotal = monthsTotal / 12;
      rendementReel = (Math.pow(valeurPEA / (totalVerse - totalFrais), 1 / yearsTotal) - 1) * 100;
    }
  }

  const progressionPct = (capitalTotal / 1000000 * 100);
  const progressionPctText = progressionPct.toFixed(2);

  console.log('Plus-value calculée:', plusValue);
  console.log('Valeur PEA:', valeurPEA);
  console.log('Total versé:', totalVerse);
  console.log('Total frais:', totalFrais);
  console.log('Rendement réel:', rendementReel);

  document.getElementById('capitalTotal').textContent = formatEuro(capitalTotal);
  document.getElementById('valeurPEA').textContent = formatEuro(valeurPEA);
  
  // Affichage de la plus-value
  const plusValueElement = document.getElementById('plusValue');
  const plusValueText = (plusValue >= 0 ? '+ ' : '- ') + formatEuro(Math.abs(plusValue));
  plusValueElement.textContent = plusValueText;
  plusValueElement.style.color = plusValue >= 0 ? '#39b46e' : '#e53e3e';
  
  // Affichage du rendement réel
  document.getElementById('rendementReel').textContent = rendementReel.toFixed(2) + '% / an';
  
  console.log('Plus-value affichée:', plusValueText);
  
  document.getElementById('progression').textContent = progressionPctText + '%';
  const width = Math.min(Math.max(progressionPct, 0), 100);
  const bar = document.getElementById('progressBar');
  bar.style.width = width + '%';
  bar.textContent = progressionPctText + '%';

  afficherHistorique();
  afficherProjection(capitalTotal, investissement, rendement, age);
  creerGraphique();
  sauvegarder();
  
  console.log('Calcul terminé!');
}

function ajouterMois() {
  const mois = document.getElementById('nouveauMois').value;
  const montant = Number(document.getElementById('nouveauMontant').value) || 0;
  if (!mois || montant <= 0) {
    alert('❌ Remplis correctement le mois et le montant.');
    return;
  }
  const msciWorldPct = (Number(document.getElementById('msciWorld').value) || 85) / 100;
  const msciEMPct = (Number(document.getElementById('msciEM').value) || 15) / 100;

  const obj = {
    mois: mois,
    montant: montant,
    world: Math.round(montant * msciWorldPct * 100) / 100,
    em: Math.round(montant * msciEMPct * 100) / 100,
    date: new Date(mois + '-01'),
    id: Date.now() + Math.floor(Math.random()*1000)
  };

  historiqueMois.push(obj);
  historiqueMois.sort((a,b) => a.date - b.date);
  document.getElementById('nouveauMois').value = '';
  document.getElementById('nouveauMontant').value = montant;
  calculer();
}

function supprimerMois(id) {
  if (!confirm('Supprimer cet enregistrement ?')) return;
  historiqueMois = historiqueMois.filter(m => Number(m.id) !== Number(id));
  calculer();
}

function afficherHistorique() {
  const tbody = document.getElementById('historique');
  if (historiqueMois.length === 0) {
    tbody.innerHTML = '<tr><td colspan="7" style="text-align:center;color:#718096">Aucun investissement enregistré. Ajoute ton premier mois !</td></tr>';
    return;
  }

  const rendement = Number(document.getElementById('rendement').value) / 100 || 0.07;
  const today = new Date();
  let valeurCumulee = 0;
  let totalVerse = 0;
  let html = '';

  historiqueMois.forEach((item, index) => {
    const depDate = item.date instanceof Date ? item.date : new Date(item.mois + '-01');
    let monthsElapsed = (today.getFullYear() - depDate.getFullYear()) * 12 + (today.getMonth() - depDate.getMonth());
    if (monthsElapsed < 0) monthsElapsed = 0;
    const monthlyRate = rendement / 12;
    const valueThis = item.montant * Math.pow(1 + monthlyRate, monthsElapsed);
    valeurCumulee += valueThis;
    totalVerse += item.montant;
    const plusValue = valeurCumulee - totalVerse;
    const moisFormate = depDate.toLocaleDateString('fr-FR', { month:'long', year:'numeric' });

    html += `
      <tr>
        <td>${moisFormate}</td>
        <td><strong>${formatEuro(item.montant)}</strong></td>
        <td>${formatEuro(item.world)}</td>
        <td>${formatEuro(item.em)}</td>
        <td class="positive"><strong>${formatEuro(valeurCumulee)}</strong></td>
        <td class="positive">${(plusValue>=0?'+':'')}${formatEuro(plusValue)}</td>
        <td><button class="btn-delete" data-id="${item.id}" title="Supprimer">🗑️</button></td>
      </tr>
    `;
  });

  tbody.innerHTML = html;
}

document.addEventListener('click', function(e) {
  const t = e.target;
  if (t && t.classList && t.classList.contains('btn-delete')) {
    const id = t.getAttribute('data-id');
    if (id) supprimerMois(id);
  }
});

function afficherProjection(capitalActuel, investissement, rendementAnn, ageActuel) {
  const ages = [20,25,30,35,40,45];
  const grid = document.getElementById('projectionGrid');
  const tbody = document.getElementById('projectionBody');
  grid.innerHTML = '';
  tbody.innerHTML = '';

  const monthlyRate = rendementAnn / 12;

  ages.forEach(age => {
    if (age <= ageActuel) return;
    const years = age - ageActuel;
    const months = years * 12;
    let capitalFinal;
    if (monthlyRate === 0) {
      capitalFinal = capitalActuel + investissement * months;
    } else {
      capitalFinal = capitalActuel * Math.pow(1 + monthlyRate, months) +
                     investissement * ( (Math.pow(1 + monthlyRate, months) - 1) / monthlyRate );
    }
    const totalVerse = capitalActuel + investissement * months;
    const plusValue = capitalFinal - totalVerse;

    const card = document.createElement('div');
    card.className = 'projection-card';
    card.innerHTML = `<div class="projection-age">${age} ans</div><div class="projection-amount">${formatEuro(capitalFinal)}</div>`;
    grid.appendChild(card);

    const tr = document.createElement('tr');
    tr.innerHTML = `<td><strong>${age} ans</strong></td>
                    <td>${years} an${years>1?'s':''}</td>
                    <td>${formatEuro(totalVerse)}</td>
                    <td class="positive"><strong>${formatEuro(capitalFinal)}</strong></td>
                    <td class="positive">${(plusValue>=0?'+':'')}${formatEuro(plusValue)}</td>`;
    tbody.appendChild(tr);
  });
}

function formatEuro(valeur) {
  if (valeur === null || valeur === undefined || isNaN(Number(valeur))) return '0 €';
  return Math.round(Number(valeur)).toLocaleString('fr-FR') + ' €';
}

// Nouvelle fonction : Graphique d'évolution
function creerGraphique() {
  if (historiqueMois.length === 0) return;
  
  const rendementAnn = Number(document.getElementById('rendement').value) || 7;
  const fraisCourtage = Number(document.getElementById('fraisCourtage').value) || 0.2;
  const rendement = (rendementAnn - fraisCourtage) / 100;
  const today = new Date();
  
  // Trier par date
  historiqueMois.sort((a,b) => a.date - b.date);
  
  const labels = [];
  const data = [];
  let cumulVerse = 0;
  let cumulValeur = 0;
  
  historiqueMois.forEach(item => {
    const depDate = item.date instanceof Date ? item.date : new Date(item.mois + '-01');
    let monthsElapsed = (today.getFullYear() - depDate.getFullYear()) * 12 + (today.getMonth() - depDate.getMonth());
    if (monthsElapsed < 0) monthsElapsed = 0;
    const monthlyRate = rendement / 12;
    const fraisMontant = item.montant * (fraisCourtage / 100);
    const montantNet = item.montant - fraisMontant;
    const value = montantNet * Math.pow(1 + monthlyRate, monthsElapsed);
    cumulValeur += value;
    cumulVerse += item.montant;
    
    labels.push(depDate.toLocaleDateString('fr-FR', { month: 'short', year: '2-digit' }));
    data.push(Math.round(cumulValeur));
  });
  
  const ctx = document.getElementById('chartEvolution');
  if (!ctx) return;
  
  // Détruire l'ancien graphique s'il existe
  if (chartInstance) {
    chartInstance.destroy();
  }
  
  chartInstance = new Chart(ctx, {
    type: 'line',
    data: {
      labels: labels,
      datasets: [{
        label: 'Valeur du portefeuille',
        data: data,
        borderColor: '#39b46e',
        backgroundColor: 'rgba(57, 180, 110, 0.1)',
        borderWidth: 3,
        fill: true,
        tension: 0.4
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: true,
      plugins: {
        legend: {
          labels: { color: '#e2e8f0', font: { size: 14 } }
        }
      },
      scales: {
        y: {
          beginAtZero: true,
          ticks: { 
            color: '#9ca3af',
            callback: function(value) {
              return value.toLocaleString('fr-FR') + ' €';
            }
          },
          grid: { color: '#374151' }
        },
        x: {
          ticks: { color: '#9ca3af' },
          grid: { color: '#374151' }
        }
      }
    }
  });
}

// Nouvelle fonction : Calculateur d'objectif
function calculerObjectif() {
  const objectifMontant = Number(document.getElementById('objectifMontant').value) || 1000000;
  const objectifAge = Number(document.getElementById('objectifAge').value) || 45;
  const ageActuel = Number(document.getElementById('age').value) || 17;
  const rendementAnn = Number(document.getElementById('rendement').value) || 7;
  const fraisCourtage = Number(document.getElementById('fraisCourtage').value) || 0.2;
  const livretA = Number(document.getElementById('livretA').value) || 0;
  const compteCourant = Number(document.getElementById('compteCourant').value) || 0;
  
  // Calculer la valeur actuelle du PEA
  const today = new Date();
  const rendement = (rendementAnn - fraisCourtage) / 100;
  let valeurPEAActuelle = 0;
  
  historiqueMois.forEach(item => {
    const depDate = item.date instanceof Date ? item.date : new Date(item.mois + '-01');
    let monthsElapsed = (today.getFullYear() - depDate.getFullYear()) * 12 + (today.getMonth() - depDate.getMonth());
    if (monthsElapsed < 0) monthsElapsed = 0;
    const monthlyRate = rendement / 12;
    const fraisMontant = item.montant * (fraisCourtage / 100);
    const montantNet = item.montant - fraisMontant;
    const value = montantNet * Math.pow(1 + monthlyRate, monthsElapsed);
    valeurPEAActuelle += value;
  });
  
  const capitalActuel = livretA + compteCourant + valeurPEAActuelle;
  const years = objectifAge - ageActuel;
  
  if (years <= 0) {
    alert('⚠️ L\'âge cible doit être supérieur à ton âge actuel !');
    return;
  }
  
  const months = years * 12;
  const monthlyRate = rendement / 12;
  
  // Formule inversée pour calculer le versement mensuel nécessaire
  // Objectif = Capital_actuel * (1+r)^n + Versement * ((1+r)^n - 1) / r
  // Versement = (Objectif - Capital_actuel * (1+r)^n) * r / ((1+r)^n - 1)
  
  const facteur = Math.pow(1 + monthlyRate, months);
  const investissementMensuel = ((objectifMontant - capitalActuel * facteur) * monthlyRate) / (facteur - 1);
  
  document.getElementById('objMontant').textContent = formatEuro(objectifMontant);
  document.getElementById('objAge').textContent = objectifAge;
  document.getElementById('objInvestissement').textContent = formatEuro(Math.max(0, investissementMensuel));
  document.getElementById('resultatObjectif').style.display = 'block';
}
</script>
</body>
</html>

