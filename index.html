<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Dashboard PEA - LUKA_INVEST_PRO</title>
<style>
*{box-sizing:border-box}
body{
  font-family: "Segoe UI", Roboto, Arial, sans-serif;
  background: linear-gradient(135deg,#f5f7fa 0%,#e8ecf1 100%);
  margin:0;padding:22px;color:#24303a;
}
.container{max-width:1400px;margin:0 auto;}
.header{
  background:linear-gradient(135deg,#39b46e 0%,#2d8f57 100%);
  color:#fff;padding:36px;border-radius:18px;margin-bottom:26px;
  box-shadow:0 10px 40px rgba(57,180,110,0.18);text-align:center;
}
.header h1{font-size:34px;margin-bottom:6px}
.header p{opacity:.95;font-size:16px}
.params-section{
  background:#fff;border-radius:14px;padding:26px;margin-bottom:22px;
  box-shadow:0 6px 20px rgba(0,0,0,0.06);
}
.params-title{font-size:20px;font-weight:700;color:#2d3748;margin-bottom:16px;display:flex;gap:10px;align-items:center}
.params-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(240px,1fr));gap:16px}
.param-item{background:#f7fafc;padding:14px;border-radius:10px;border:1px solid transparent;transition:all .18s}
.param-item:hover{transform:translateY(-3px);border-color:#39b46e22}
.param-item label{display:block;font-weight:600;color:#4a5568;margin-bottom:8px}
.param-item input{width:100%;padding:10px;border-radius:8px;border:1px solid #e2e8f0;font-size:15px}
.btn-primary{background:linear-gradient(135deg,#39b46e 0%,#2d8f57 100%);color:#fff;border:none;padding:12px 28px;border-radius:12px;font-weight:700;cursor:pointer;box-shadow:0 6px 18px rgba(57,180,110,.18)}
.btn-primary:hover{transform:translateY(-3px)}
.stats-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(220px,1fr));gap:16px;margin:20px 0}
.stat-card{background:#fff;padding:18px;border-radius:12px;box-shadow:0 6px 18px rgba(0,0,0,0.06)}
.stat-label{font-size:13px;color:#718096;margin-bottom:8px}
.stat-value{font-size:30px;font-weight:800;color:#2d3748}
.progress-bar{background:#e6eef0;height:32px;border-radius:18px;overflow:hidden;margin-top:12px}
.progress-fill{height:100%;display:flex;align-items:center;justify-content:center;font-weight:700;color:#fff;background:linear-gradient(90deg,#39b46e,#2d8f57);transition:width .5s}
.chart-section{background:#fff;border-radius:14px;padding:22px;margin-bottom:22px;box-shadow:0 6px 20px rgba(0,0,0,0.05)}
.section-title{font-size:18px;font-weight:800;color:#2d3748;margin-bottom:14px}
.table-controls{display:grid;grid-template-columns:200px 160px 120px;gap:10px;margin-bottom:12px}
.btn-add{background:linear-gradient(135deg,#7a6ff0,#6355cc);color:#fff;padding:10px;border-radius:8px;border:none;font-weight:700;cursor:pointer}
.btn-delete{background:#e53e3e;color:#fff;border:none;padding:8px 10px;border-radius:6px;cursor:pointer}
table{width:100%;border-collapse:collapse;margin-top:10px}
th,td{padding:12px;text-align:left;border-bottom:1px solid #eef2f6}
th{background:#fbfcfd;color:#2d3748;font-weight:700;font-size:13px}
.positive{color:#39b46e;font-weight:800}
.projection-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(150px,1fr));gap:14px;margin-top:10px}
.projection-card{background:linear-gradient(135deg,#7a6ff0 0%,#6355cc 100%);color:#fff;padding:16px;border-radius:10px;text-align:center}
.projection-age{font-size:20px;font-weight:800}
.projection-amount{font-size:15px;opacity:.95}
@media (max-width:720px){
  .table-controls{grid-template-columns:1fr 1fr}
}
</style>
</head>
<body>
<div class="container">
  <div class="header">
    <h1>🎯 Mon Dashboard PEA</h1>
    <p>Objectif : 1 000 000 € à 45 ans · LUKA_INVEST_PRO</p>
  </div>

  <div class="params-section">
    <div class="params-title">⚙️ Mes paramètres</div>
    <div class="params-grid">
      <div class="param-item">
        <label>💰 Revenu mensuel (€)</label>
        <input id="revenu" type="number" value="1200" min="0" />
      </div>
      <div class="param-item">
        <label>📈 Investissement mensuel (€)</label>
        <input id="investissement" type="number" value="900" min="0" />
      </div>
      <div class="param-item">
        <label>🌍 MSCI World (%)</label>
        <input id="msciWorld" type="number" value="85" min="0" max="100" />
      </div>
      <div class="param-item">
        <label>🌏 Marchés émergents (%)</label>
        <input id="msciEM" type="number" value="15" min="0" max="100" />
      </div>
      <div class="param-item">
        <label>📊 Rendement annuel (%)</label>
        <input id="rendement" type="number" value="7" step="0.1" min="0" />
      </div>
      <div class="param-item">
        <label>🎂 Mon âge actuel</label>
        <input id="age" type="number" value="17" min="0" />
      </div>
      <div class="param-item">
        <label>💚 Livret A (€)</label>
        <input id="livretA" type="number" value="3000" min="0" />
      </div>
    </div>
    <div style="text-align:center;margin-top:16px">
      <button class="btn-primary" onclick="calculer()">🚀 Calculer ma projection</button>
    </div>
  </div>

  <div class="stats-grid">
    <div class="stat-card">
      <div class="stat-label">💰 Capital total estimé</div>
      <div class="stat-value" id="capitalTotal">0 €</div>
    </div>
    <div class="stat-card">
      <div class="stat-label">📈 Valeur PEA</div>
      <div class="stat-value" id="valeurPEA">0 €</div>
    </div>
    <div class="stat-card">
      <div class="stat-label">💹 Plus-value PEA</div>
      <div class="stat-value positive" id="plusValue">+0 €</div>
    </div>
    <div class="stat-card">
      <div class="stat-label">🎯 Progression vers 1M€</div>
      <div class="stat-value" id="progression">0%</div>
      <div class="progress-bar"><div id="progressBar" class="progress-fill" style="width:0%">0%</div></div>
    </div>
  </div>

  <div class="chart-section">
    <div class="section-title">🔮 Ma projection jusqu'à 45 ans</div>
    <div id="projectionGrid" class="projection-grid"></div>
  </div>

  <div class="chart-section">
    <div class="section-title">📅 Historique d'investissement</div>
    <div class="table-controls">
      <input id="nouveauMois" type="month" />
      <input id="nouveauMontant" type="number" placeholder="Montant (€)" value="900" />
      <button class="btn-add" onclick="ajouterMois()">➕ Ajouter</button>
    </div>

    <table>
      <thead>
        <tr>
          <th>📅 Mois</th>
          <th>💰 Versement</th>
          <th>🌍 MSCI World</th>
          <th>🌏 Émergents</th>
          <th>📈 Valeur cumulée</th>
          <th>💹 Plus-value</th>
          <th>🗑️</th>
        </tr>
      </thead>
      <tbody id="historique"></tbody>
    </table>
  </div>

  <div class="chart-section">
    <div class="section-title">📊 Projection détaillée par âge</div>
    <table id="tableProjection">
      <thead>
        <tr>
          <th>🎂 Âge</th>
          <th>⏱️ Années</th>
          <th>💰 Total versé (est.)</th>
          <th>📈 Capital estimé</th>
          <th>💹 Plus-value</th>
        </tr>
      </thead>
      <tbody id="projectionBody"></tbody>
    </table>
  </div>
</div>

<script>
let historiqueMois = [];

window.onload = function() {
  const saved = localStorage.getItem('dashboardData');
  if (saved) {
    try {
      const data = JSON.parse(saved);
      document.getElementById('revenu').value = data.revenu ?? 1200;
      document.getElementById('investissement').value = data.investissement ?? 900;
      document.getElementById('msciWorld').value = data.msciWorld ?? 85;
      document.getElementById('msciEM').value = data.msciEM ?? 15;
      document.getElementById('rendement').value = data.rendement ?? 7;
      document.getElementById('age').value = data.age ?? 17;
      document.getElementById('livretA').value = data.livretA ?? 3000;
      historiqueMois = (data.historique || []).map(item => ({
        mois: item.mois,
        montant: Number(item.montant) || 0,
        world: Number(item.world) || 0,
        em: Number(item.em) || 0,
        date: new Date((item.mois || '') + '-01'),
        id: Number(item.id) || Date.now() + Math.floor(Math.random()*1000)
      }));
      historiqueMois.sort((a,b) => a.date - b.date);
    } catch(e) {
      historiqueMois = [];
    }
  }
  calculer();
};

function sauvegarder() {
  const data = {
    revenu: Number(document.getElementById('revenu').value) || 0,
    investissement: Number(document.getElementById('investissement').value) || 0,
    msciWorld: Number(document.getElementById('msciWorld').value) || 85,
    msciEM: Number(document.getElementById('msciEM').value) || 15,
    rendement: Number(document.getElementById('rendement').value) || 7,
    age: Number(document.getElementById('age').value) || 17,
    livretA: Number(document.getElementById('livretA').value) || 0,
    historique: historiqueMois.map(h => ({mois:h.mois,montant:h.montant,world:h.world,em:h.em,id:h.id}))
  };
  localStorage.setItem('dashboardData', JSON.stringify(data));
}

function calculer() {
  const livretA = Number(document.getElementById('livretA').value) || 0;
  const rendementAnn = Number(document.getElementById('rendement').value) || 7;
  const rendement = rendementAnn / 100;
  const age = Number(document.getElementById('age').value) || 17;
  const investissement = Number(document.getElementById('investissement').value) || 0;

  // ✅ correction : créer une ligne par défaut si historique vide
  if (historiqueMois.length === 0 && investissement > 0) {
    const now = new Date();
    const mois = now.toISOString().slice(0,7);
    historiqueMois.push({
      mois: mois,
      montant: investissement,
      world: investissement * 0.85,
      em: investissement * 0.15,
      date: new Date(mois + '-01'),
      id: Date.now()
    });
  }

  const today = new Date();
  let valeurPEA = 0;
  let totalVerse = 0;

  historiqueMois.sort((a,b) => a.date - b.date);

  historiqueMois.forEach(item => {
    const depDate = item.date instanceof Date ? item.date : new Date(item.mois + '-01');
    let monthsElapsed = (today.getFullYear()-depDate.getFullYear())*12+(today.getMonth()-depDate.getMonth());
    if (monthsElapsed < 0) monthsElapsed = 0;
    const monthlyRate = rendement/12;
    const value = item.montant * Math.pow(1 + monthlyRate, monthsElapsed);
    valeurPEA += value;
    totalVerse += item.montant;
  });

  const plusValue = valeurPEA - totalVerse;
  const capitalTotal = livretA + valeurPEA;

  const progressionPct = (capitalTotal / 1000000 * 100);
  const progressionPctText = progressionPct.toFixed(2);

  document.getElementById('capitalTotal').textContent = formatEuro(capitalTotal);
  document.getElementById('valeurPEA').textContent = formatEuro(valeurPEA);
  document.getElementById('plusValue').textContent = (plusValue>=0?'+':'') + formatEuro(plusValue);
  document.getElementById('progression').textContent = progressionPctText + '%';
  const width = Math.min(Math.max(progressionPct,0),100);
  const bar = document.getElementById('progressBar');
  bar.style.width = width + '%';
  bar.textContent = progressionPctText + '%';

  afficherHistorique();
  afficherProjection(capitalTotal, investissement, rendement, age);
  sauvegarder();
}

function ajouterMois() {
  const mois = document.getElementById('nouveauMois').value;
  const montant = Number(document.getElementById('nouveauMontant').value) || 0;
  if (!mois || montant <= 0) {alert('❌ Remplis correctement le mois et le montant.');return;}
  const msciWorldPct = (Number(document.getElementById('msciWorld').value) || 85)/100;
  const msciEMPct = (Number(document.getElementById('msciEM').value) || 15)/100;

  const obj={mois:mois,montant:montant,world:Math.round(montant*msciWorldPct*100)/100,em:Math.round(montant*msciEMPct*100)/100,date:new Date(mois+'-01'),id:Date.now()+Math.floor(Math.random()*1000)};
  historiqueMois.push(obj);
  historiqueMois.sort((a,b)=>a.date-b.date);
  document.getElementById('nouveauMois').value='';
  calculer();
}

function supprimerMois(id) {
  if (!confirm('Supprimer cet enregistrement ?')) return;
  historiqueMois = historiqueMois.filter(m=>Number(m.id)!==Number(id));
  calculer();
}

function afficherHistorique() {
  const tbody = document.getElementById('historique');
  if (historiqueMois.length===0) {
    tbody.innerHTML='<tr><td colspan="7" style="text-align:center;color:#718096">Aucun investissement enregistré. Ajoute ton premier mois !</td></tr>';
    return;
  }
  const rendement = Number(document.getElementById('rendement').value)/100 || 0.07;
  const today = new Date();
  let valeurCumulee=0,totalVerse=0,html='';
  historiqueMois.forEach(item=>{
    const depDate=item.date instanceof Date?item.date:new Date(item.mois+'-01');
    let monthsElapsed=(today.getFullYear()-depDate.getFullYear())*12+(today.getMonth()-depDate.getMonth());
    if (monthsElapsed<0)monthsElapsed=0;
    const monthlyRate=rendement/12;
    const valueThis=item.montant*Math.pow(1+monthlyRate,monthsElapsed);
    valeurCumulee+=valueThis;
    totalVerse+=item.montant;
    const plusValue=valeurCumulee-totalVerse;
    const moisFormate=depDate.toLocaleDateString('fr-FR',{month:'long',year:'numeric'});
    html+=`<tr>
      <td>${moisFormate}</td>
      <td><strong>${formatEuro(item.montant)}</strong></td>
      <td>${formatEuro(item.world)}</td>
      <td>${formatEuro(item.em)}</td>
      <td class="positive"><strong>${formatEuro(valeurCumulee)}</strong></td>
      <td class="positive">${(plusValue>=0?'+':'')}${formatEuro(plusValue)}</td>
      <td><button class="btn-delete" data-id="${item.id}" title="Supprimer">🗑️</button
